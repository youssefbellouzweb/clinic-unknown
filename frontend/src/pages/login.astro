---
import Layout from "../layouts/Layout.astro";
import Navbar from "../components/layout/Navbar";
import Footer from "../components/layout/Footer";
---

<Layout title="Login - ClinicHub">
    <div class="min-h-screen flex flex-col">
        <Navbar client:load />

        <main class="flex-1 flex items-center justify-center py-12 px-4">
            <div class="max-w-md w-full">
                <div class="bg-white rounded-2xl shadow-xl p-8">
                    <div class="text-center mb-8">
                        <h1 class="text-3xl font-bold text-gray-900 mb-2">
                            Welcome Back
                        </h1>
                        <p class="text-gray-600">Sign in to your account</p>
                    </div>

                    <form id="loginForm" class="space-y-6">
                        <div
                            id="errorAlert"
                            class="hidden bg-red-50 border border-red-200 text-red-800 rounded-lg p-4"
                        >
                            <p id="errorMessage"></p>
                        </div>

                        <div>
                            <label
                                for="email"
                                class="block text-sm font-medium text-gray-700 mb-1"
                            >
                                Email Address
                            </label>
                            <input
                                type="email"
                                id="email"
                                name="email"
                                required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                                placeholder="you@example.com"
                            />
                        </div>

                        <div>
                            <label
                                for="password"
                                class="block text-sm font-medium text-gray-700 mb-1"
                            >
                                Password
                            </label>
                            <input
                                type="password"
                                id="password"
                                name="password"
                                required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                                placeholder="••••••••"
                            />
                        </div>

                        <button
                            type="submit"
                            class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                        >
                            Sign In
                        </button>
                    </form>

                    <div class="mt-6 text-center">
                        <p class="text-gray-600">
                            Don't have a clinic account?
                            <a
                                href="/register"
                                class="text-blue-600 hover:text-blue-700 font-semibold"
                            >
                                Register your clinic
                            </a>
                        </p>
                    </div>
                </div>
            </div>
        </main>

        <Footer client:load />
    </div>
</Layout>

<script>
    import { auth } from "../lib/services";

    const form = document.getElementById("loginForm") as HTMLFormElement;
    const errorAlert = document.getElementById("errorAlert") as HTMLDivElement;
    const errorMessage = document.getElementById(
        "errorMessage",
    ) as HTMLParagraphElement;

    form?.addEventListener("submit", async (e) => {
        e.preventDefault();

        const formData = new FormData(form);
        const email = formData.get("email") as string;
        const password = formData.get("password") as string;

        try {
            errorAlert.classList.add("hidden");

            const response = await auth.login(email, password);

            // Redirect based on user role
            // Backend returns { success: true, data: { user: ..., accessToken: ... } }
            // Service returns response.data which is the whole object above
            const { user, accessToken } = response.data;

            // Store access token
            localStorage.setItem("accessToken", accessToken);

            if (user.role === "patient") {
                // Patient portal not fully implemented yet
                window.location.href = "/dashboard";
            } else {
                window.location.href = "/dashboard";
            }
        } catch (error: any) {
            errorAlert.classList.remove("hidden");
            errorMessage.textContent =
                error.response?.data?.error ||
                "Login failed. Please try again.";
        }
    });
</script>
