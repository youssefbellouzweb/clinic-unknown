---
import Layout from "../layouts/Layout.astro";
import { LogIn, User, Lock, ArrowLeft } from "lucide-react";
import Button from "../components/ui/Button";
import Input from "../components/ui/Input";
import Card from "../components/ui/Card";
import Alert from "../components/ui/Alert";
---

<Layout title="Login - ClinicHub">
    <div
        class="min-h-screen flex items-center justify-center relative overflow-hidden bg-gray-50 py-12 px-4 sm:px-6 lg:px-8"
    >
        <!-- Animated Background -->
        <div class="absolute inset-0 z-0">
            <div
                class="absolute top-0 left-0 w-full h-full bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-5"
            >
            </div>
            <div
                class="absolute top-0 right-0 w-[600px] h-[600px] bg-blue-400/10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 animate-pulse-slow"
            >
            </div>
            <div
                class="absolute bottom-0 left-0 w-[500px] h-[500px] bg-purple-400/10 rounded-full blur-3xl translate-y-1/2 -translate-x-1/2 animate-pulse-slow"
                style="animation-delay: 1.5s;"
            >
            </div>
        </div>

        <div class="w-full max-w-md relative z-10 animate-scale-in">
            <div class="mb-8 text-center">
                <a
                    href="/"
                    class="inline-flex items-center text-gray-500 hover:text-blue-600 transition-colors mb-6"
                >
                    <ArrowLeft size={16} class="mr-2" />
                    Back to Home
                </a>
                <h2 class="text-3xl font-bold text-gray-900">Welcome Back</h2>
                <p class="mt-2 text-gray-600">
                    Sign in to your account to continue
                </p>
            </div>

            <Card
                variant="glass"
                className="p-8 shadow-xl border-t-4 border-t-blue-500"
            >
                <div id="error-alert" class="hidden mb-6">
                    <Alert variant="error" title="Login Failed" dismissible>
                        <span id="error-message"></span>
                    </Alert>
                </div>

                <form id="login-form" class="space-y-6">
                    <div>
                        <Input
                            client:load
                            label="Email Address"
                            type="email"
                            id="email"
                            name="email"
                            required
                            icon={User}
                            placeholder="doctor@clinic.com"
                        />
                    </div>

                    <div>
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-sm"></span>
                            <a
                                href="/forgot-password"
                                class="text-sm font-medium text-blue-600 hover:text-blue-500 transition-colors"
                            >
                                Forgot password?
                            </a>
                        </div>
                        <Input
                            client:load
                            label="Password"
                            type="password"
                            id="password"
                            name="password"
                            required
                            icon={Lock}
                            showPasswordToggle
                            placeholder="••••••••"
                        />
                    </div>

                    <Button
                        client:load
                        type="submit"
                        variant="gradient"
                        size="lg"
                        className="w-full shadow-colored hover-lift"
                        icon={LogIn}
                        iconPosition="left"
                    >
                        Sign In
                    </Button>
                </form>

                <div class="mt-8 pt-6 border-t border-gray-100 text-center">
                    <p class="text-sm text-gray-600">
                        Don't have an account?
                        <a
                            href="/register"
                            class="font-medium text-blue-600 hover:text-blue-500 transition-colors ml-1"
                        >
                            Register your clinic
                        </a>
                    </p>
                </div>
            </Card>

            <p class="mt-8 text-center text-xs text-gray-400">
                &copy; 2024 ClinicHub. Secure & HIPAA Compliant.
            </p>
        </div>
    </div>
</Layout>

<script>
    import axios from "axios";

    const loginForm = document.getElementById("login-form");
    const errorAlert = document.getElementById("error-alert");
    const errorMessage = document.getElementById("error-message");

    if (loginForm) {
        loginForm.addEventListener("submit", async (e) => {
            e.preventDefault();

            // Reset error state
            if (errorAlert) errorAlert.classList.add("hidden");

            // Show loading state on button
            const submitBtn = loginForm.querySelector('button[type="submit"]');
            let originalBtnText = "";

            if (submitBtn) {
                originalBtnText = submitBtn.innerHTML;
                (submitBtn as HTMLButtonElement).disabled = true;
                submitBtn.innerHTML =
                    '<span class="animate-spin mr-2">⟳</span> Signing in...';
            }

            const formData = new FormData(e.target as HTMLFormElement);
            const data = Object.fromEntries(formData);

            try {
                const response = await axios.post(
                    "http://localhost:3000/api/auth/login",
                    data,
                );

                // Store token and user data
                localStorage.setItem("token", response.data.token);
                localStorage.setItem(
                    "user",
                    JSON.stringify(response.data.user),
                );

                // Show success animation or redirect
                window.location.href = "/dashboard";
            } catch (error: any) {
                console.error("Login error:", error);
                if (errorAlert) errorAlert.classList.remove("hidden");
                if (errorMessage) {
                    errorMessage.textContent =
                        error.response?.data?.message ||
                        "An error occurred during login";
                }

                // Reset button
                if (submitBtn) {
                    (submitBtn as HTMLButtonElement).disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                }
            }
        });
    }
</script>
