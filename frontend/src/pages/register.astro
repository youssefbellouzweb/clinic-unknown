---
import Layout from "../layouts/Layout.astro";
import {
    UserPlus,
    Building2,
    User,
    Mail,
    Lock,
    Phone,
    MapPin,
    ArrowLeft,
} from "lucide-react";
import Button from "../components/ui/Button";
import Input from "../components/ui/Input";
import Card from "../components/ui/Card";
import Alert from "../components/ui/Alert";
---

<Layout title="Register Clinic - ClinicHub">
    <div
        class="min-h-screen flex items-center justify-center relative overflow-hidden bg-gray-50 py-12 px-4 sm:px-6 lg:px-8"
    >
        <!-- Animated Background -->
        <div class="absolute inset-0 z-0">
            <div
                class="absolute top-0 left-0 w-full h-full bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-5"
            >
            </div>
            <div
                class="absolute top-0 right-0 w-[800px] h-[800px] bg-green-400/10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 animate-pulse-slow"
            >
            </div>
            <div
                class="absolute bottom-0 left-0 w-[600px] h-[600px] bg-blue-400/10 rounded-full blur-3xl translate-y-1/2 -translate-x-1/2 animate-pulse-slow"
                style="animation-delay: 1s;"
            >
            </div>
        </div>

        <div class="w-full max-w-2xl relative z-10 animate-scale-in">
            <div class="mb-8 text-center">
                <a
                    href="/"
                    class="inline-flex items-center text-gray-500 hover:text-blue-600 transition-colors mb-6"
                >
                    <ArrowLeft size={16} class="mr-2" />
                    Back to Home
                </a>
                <h2 class="text-3xl font-bold text-gray-900">
                    Register Your Clinic
                </h2>
                <p class="mt-2 text-gray-600">
                    Start your 14-day free trial today
                </p>
            </div>

            <Card
                variant="glass"
                className="p-8 shadow-xl border-t-4 border-t-green-500"
            >
                <div id="error-alert" class="hidden mb-6">
                    <Alert
                        variant="error"
                        title="Registration Failed"
                        dismissible
                    >
                        <span id="error-message"></span>
                    </Alert>
                </div>

                <form id="register-form" class="space-y-8">
                    <!-- Clinic Information -->
                    <div>
                        <h3
                            class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2"
                        >
                            <Building2 size={20} class="text-blue-500" />
                            Clinic Details
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <Input
                                client:load
                                label="Clinic Name"
                                type="text"
                                id="clinicName"
                                name="clinicName"
                                required
                                icon={Building2}
                                placeholder="Medical Center"
                            />
                            <Input
                                client:load
                                label="Address"
                                type="text"
                                id="address"
                                name="address"
                                required
                                icon={MapPin}
                                placeholder="123 Health St"
                            />
                            <Input
                                client:load
                                label="Phone Number"
                                type="tel"
                                id="phone"
                                name="phone"
                                required
                                icon={Phone}
                                placeholder="+1 (555) 000-0000"
                            />
                        </div>
                    </div>

                    <!-- Admin Information -->
                    <div>
                        <h3
                            class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2"
                        >
                            <User size={20} class="text-blue-500" />
                            Administrator Account
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <Input
                                client:load
                                label="Full Name"
                                type="text"
                                id="name"
                                name="name"
                                required
                                icon={User}
                                placeholder="Dr. John Doe"
                            />
                            <Input
                                client:load
                                label="Email Address"
                                type="email"
                                id="email"
                                name="email"
                                required
                                icon={Mail}
                                placeholder="admin@clinic.com"
                            />
                            <Input
                                client:load
                                label="Password"
                                type="password"
                                id="password"
                                name="password"
                                required
                                icon={Lock}
                                showPasswordToggle
                                placeholder="••••••••"
                            />
                            <Input
                                client:load
                                label="Confirm Password"
                                type="password"
                                id="confirmPassword"
                                name="confirmPassword"
                                required
                                icon={Lock}
                                showPasswordToggle
                                placeholder="••••••••"
                            />
                        </div>
                    </div>

                    <div class="pt-4">
                        <Button
                            client:load
                            type="submit"
                            variant="gradient"
                            size="lg"
                            className="w-full shadow-colored hover-lift"
                            icon={UserPlus}
                            iconPosition="left"
                        >
                            Create Account
                        </Button>
                    </div>
                </form>

                <div class="mt-8 pt-6 border-t border-gray-100 text-center">
                    <p class="text-sm text-gray-600">
                        Already have an account?
                        <a
                            href="/login"
                            class="font-medium text-blue-600 hover:text-blue-500 transition-colors ml-1"
                        >
                            Sign in here
                        </a>
                    </p>
                </div>
            </Card>

            <p class="mt-8 text-center text-xs text-gray-400">
                By registering, you agree to our Terms of Service and Privacy
                Policy.
            </p>
        </div>
    </div>
</Layout>

<script>
    import axios from "axios";

    const registerForm = document.getElementById("register-form");
    const errorAlert = document.getElementById("error-alert");
    const errorMessage = document.getElementById("error-message");

    if (registerForm) {
        registerForm.addEventListener("submit", async (e) => {
            e.preventDefault();

            // Reset error state
            errorAlert.classList.add("hidden");

            const formData = new FormData(e.target as HTMLFormElement);
            const data = Object.fromEntries(formData);

            // Basic validation
            if (data.password !== data.confirmPassword) {
                errorAlert.classList.remove("hidden");
                errorMessage.textContent = "Passwords do not match";
                return;
            }

            // Show loading state
            const submitBtn = registerForm.querySelector(
                'button[type="submit"]',
            );
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML =
                '<span class="animate-spin mr-2">⟳</span> Creating Account...';

            try {
                // 1. Register Clinic
                const clinicResponse = await axios.post(
                    "http://localhost:3000/api/clinics",
                    {
                        name: data.clinicName,
                        address: data.address,
                        phone: data.phone,
                    },
                );

                const clinicId = clinicResponse.data.id;

                // 2. Register Admin User
                await axios.post("http://localhost:3000/api/auth/register", {
                    name: data.name,
                    email: data.email,
                    password: data.password,
                    role: "admin",
                    clinicId: clinicId,
                });

                // Redirect to login on success
                window.location.href = "/login?registered=true";
            } catch (error: any) {
                console.error("Registration error:", error);
                errorAlert.classList.remove("hidden");
                errorMessage.textContent =
                    error.response?.data?.message ||
                    "An error occurred during registration";

                // Reset button
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            }
        });
    }
</script>
